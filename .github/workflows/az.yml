name: Build Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean existing config
        run: |
          rm -f Genshin-Impact-Wish-Simulator/src-tauri/tauri.conf.json
          rm -f Genshin-Impact-Wish-Simulator/src-tauri/tauri.conf.json.bak

      - name: Detect Tauri version
        id: detect-tauri
        run: |
          if [ -f "Genshin-Impact-Wish-Simulator/package.json" ]; then
            if grep -q '"@tauri-apps/cli": "2' Genshin-Impact-Wish-Simulator/package.json; then
              echo "TAURI_VERSION=2" >> $GITHUB_ENV
            else
              echo "TAURI_VERSION=1" >> $GITHUB_ENV
            fi
          else
            echo "TAURI_VERSION=1" >> $GITHUB_ENV
          fi
          echo "Using Tauri $TAURI_VERSION.x"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: Genshin-Impact-Wish-Simulator

      - name: Install Tauri CLI
        run: |
          if [ "$TAURI_VERSION" = "2" ]; then
            npm install -g @tauri-apps/cli@next
          else
            npm install -g @tauri-apps/cli@latest
          fi

      - name: Generate and Validate Config
        run: |
          CONFIG_DIR="Genshin-Impact-Wish-Simulator/src-tauri"
          CONFIG_FILE="$CONFIG_DIR/tauri.conf.json"
          
          # 确保目录存在
          mkdir -p $CONFIG_DIR
          
          # 生成全新配置
          if [ "$TAURI_VERSION" = "2" ]; then
            echo '{
              "$schema": "../node_modules/@tauri-apps/cli/schema.json",
              "productName": "genshin-impact",
              "version": "0.1.0",
              "build": {
                "frontend": {
                  "distDir": "../dist",
                  "devPath": "http://localhost:8080"
                }
              },
              "tauri": {
                "bundle": {
                  "identifier": "com.example.genshinimpact"
                }
              }
            }' > $CONFIG_FILE
          else
            echo '{
              "build": {
                "distDir": "../dist",
                "devPath": "http://localhost:8080"
              },
              "package": {
                "productName": "genshin-impact",
                "version": "0.1.0"
              },
              "tauri": {
                "bundle": {
                  "identifier": "com.example.genshinimpact",
                  "icon": ["icons/32x32.png", "icons/128x128.png"]
                },
                "allowlist": {
                  "all": true
                }
              }
            }' > $CONFIG_FILE
          fi
          
          # 验证配置
          echo "Generated config:"
          cat $CONFIG_FILE
          echo -e "\nValidating config..."
          if [ "$TAURI_VERSION" = "2" ]; then
            tauri config validate --schema ../node_modules/@tauri-apps/cli/schema.json
          else
            tauri config validate
          fi

      - name: Init Tauri Android
        run: |
          cd Genshin-Impact-Wish-Simulator
          rm -rf src-tauri/target
          tauri android init

      - name: Build APK
        run: |
          cd Genshin-Impact-Wish-Simulator
          tauri android build --debug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: genshin-impact-apk
          path: Genshin-Impact-Wish-Simulator/src-tauri/target/android/debug/*.apk